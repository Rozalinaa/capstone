version: 2.1

orbs:
  python: circleci/python@1.5.0
  aws-cli: circleci/aws-cli@2.0.6

jobs:
          
  build-network:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: create network
          # This assumes pytest is installed via the install-package step above
          command: |
            aws cloudformation deploy --template-file kubernetes-network.yml \
              --stack-name capstone-vpc \
              --parameter-overrides file://kubernetes-network-params.json \
              --tags project=capstone \
              


# build cluster for kubernetes            
  build-cluster:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: create cluster
          # This assumes pytest is installed via the install-package step above
          no_output_timeout: 20m
          command: |
            aws cloudformation deploy --stack-name eks-capstone \
              --template-file kubernetes-cluster.yml \
              --parameter-overrides file://kubernetes-cluster-params.json \
              --tags project=capstone \
              --capabilities CAPABILITY_NAMED_IAM

# set context for cluster
  set-context:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: create network
          command: | 
            aws eks --region us-east-1 update-kubeconfig --name prod 
          
# run docker    
  run-docker:
    machine: true
    steps:
      - checkout
      - run: |
          echo "building..."
          docker build --tag=helloworldapp .
          echo docker image ls
          docker image ls
          echo "run now.."
          docker run -p 5000:5000 helloworldapp

#build docker image  
  build-docker:
    machine: true
    steps:
      - checkout
      - run:
          name: build image and push to ecr
          command: |
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 741506559500.dkr.ecr.us-east-1.amazonaws.com
            docker build -t capstone .
            docker tag capstone:latest 741506559500.dkr.ecr.us-east-1.amazonaws.com/capstone:latest
            docker push 741506559500.dkr.ecr.us-east-1.amazonaws.com/capstone:latest


# run kubernetes
  run-kubernetes:
    machine: true
    steps:
      - checkout
      - run:
          name: install kubectl
          command: |
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
            kubectl version --client
      - run:
          name: run docker
          command: | 
            echo 'minikube status'
            minikube status
            echo "get info"
            gcloud container clusters get-credentials "eks-capstone"
            echo "create namespace"
            kubectl create namespace eks-sample-app
            echo 'logging in'
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 741506559500.dkr.ecr.us-east-1.amazonaws.com
            echo 'start deployment'
            kubectl apply -f deployment.yaml
            echo 'get deployments...'
            kubectl get deployments
            echo 'get services...'
            kubectl get services
 

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
#  build-infra:
#    jobs:
#      - build-network
#      - build-cluster:
#          requires: [build-network]
#      - set-context:
#          requires: [build-cluster]
  change-version:
    jobs:
      - build-docker
      - run-kubernetes:
          requires: [build-docker]

